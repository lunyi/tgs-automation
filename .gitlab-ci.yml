stages:
  - build-and-test
  - docker-build
  - deploy

variables:
  ImageName: "pgtgs/expired_domain"
  MomoImageName: "pgtgs/momo-data"
  DataRetrieceImageName: "pgtgs/data-retrieve"
  BrandsImageName: "pgtgs/brands-info"
  Registry: "registry.hub.docker.com"

build_job:
  stage: build-and-test
  only:
    - main
  script:
    - ls -al
    - pwd
    - hostname
    - export PATH=$PATH:/usr/local/go/bin
    - echo "PATH=$PATH"
    - go mod download
    - go build ./...
    - go test ./...
    - go build -o main ./cmd/expired_domain

docker_build_job:
  stage: docker-build
  only:
    - main
  script:
    - export TAG="$(date -d $CI_PIPELINE_CREATED_AT +%Y%m%d).$CI_PIPELINE_IID"
    - export TAG="latest"
    - docker build -t $ImageName:$TAG -f dockerfiles/Dockerfile.expired_domain .
    - docker push ${ImageName}:${TAG}
    - docker build -t $MomoImageName:$TAG -f dockerfiles/Dockerfile.daily_momo_data .
    - docker push ${MomoImageName}:${TAG}
    - docker build -t $BrandsImageName:$TAG -f dockerfiles/Dockerfile.daily_brand_revenue .
    - docker push ${BrandsImageName}:${TAG}
    - docker build -t $DataRetrieceImageName:$TAG -f dockerfiles/Dockerfile.data_retrieve .
    - docker push ${DataRetrieceImageName}:${TAG}
deploy_job:
  stage: deploy
  only:
    - main
  before_script:
    - export TAG="latest"
    - export KUBECONFIG=$kubeconfig_devops
    - echo "KUBECONFIG=$kubeconfig_devops"
  script:
    - kubectl set image cronjob/expired-domains expired-domain=${ImageName}:${TAG} --record -n devops
    - kubectl set image cronjob/brands-info brands-info=${BrandsImageName}:${TAG} --record -n devops