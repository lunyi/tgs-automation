stages:
  - build-and-test
  - docker-build
  - deploy

variables:
  ImageName: "pgtgs/expired_domain"
  Registry: "registry.hub.docker.com"

build_job:
  stage: build-and-test
  only:
    - main
  script:
    - ls -al
    - pwd
    - hostname
    - export PATH=$PATH:/usr/local/go/bin
    - echo "PATH=$PATH"
    - go mod download
    - go build ./...
    - go test ./...
    - go build -o main ./cmd/expired_domain

docker_build_job:
  stage: docker-build
  only:
    - main
  script:
    - export TAG="$(date -d $CI_PIPELINE_CREATED_AT +%Y%m%d).$CI_PIPELINE_IID"
    - export TAG="latest"
    - docker build -t $ImageName:$TAG -f dockerfiles/Dockerfile.expired_domain .
    - docker push ${ImageName}:${TAG}

deploy_job:
  stage: deploy
  only:
    - main
  before_script:
    - export KUBECONFIG=$kubeconfig_staging
    - echo "KUBECONFIG=$kubeconfig_staging
  script:
    - kubectl set image cronjob/expired-domains expired-domain=${ImageName}:${TAG} --record -n devops